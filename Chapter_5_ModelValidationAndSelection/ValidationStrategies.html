
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2. Validation strategies &#8212; Reproducible Machine Learning for Credit Card Fraud detection - Practical handbook</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/book.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/jtag_0.js"></script>
    <script src="../_static/jtag_1.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://fraud-detection-handbook.github.io/fraud-detection-handbook/Chapter_5_ModelValidationAndSelection/ValidationStrategies.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Model selection" href="ModelSelection.html" />
    <link rel="prev" title="1. Introduction" href="Introduction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Reproducible Machine Learning for Credit Card Fraud detection - Practical handbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Foreword.html">
   Foreword
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  1. Book overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_1_BookContent/BookContent.html">
   1. Book content and intended audience
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_1_BookContent/BookContributions.html">
   2. Book contributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_1_BookContent/HowToUse.html">
   3. How to use this book
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  2. Background
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2_Background/Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2_Background/CreditCardFraud.html">
   2. Credit card fraud scenarios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2_Background/FDS.html">
   3. Credit card fraud detection system
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2_Background/MachineLearningForFraudDetection.html">
   4. Machine learning for credit card fraud detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2_Background/Summary.html">
   5. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  3. Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/SimulatedDataset.html">
   2. Transaction data simulator
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineFeatureTransformation.html">
   3. Baseline feature transformation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html">
   4. Baseline fraud detection system
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/Baseline_RealWorldData.html">
   5. Real-world data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3_GettingStarted/Summary.html">
   6. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  4. Performance metrics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/ThresholdBased.html">
   2. Threshold-based metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/ThresholdFree.html">
   3. Threshold-free metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/TopKBased.html">
   4. Precision top-k metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/Assessment_RealWorldData.html">
   5. Real-world data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4_PerformanceMetrics/Summary.html">
   6. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  5. Model validation and model selection
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   2. Validation strategies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ModelSelection.html">
   3. Model selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ModelSelection_RealWorldData.html">
   4. Real-world data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Summary.html">
   5. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  6. Imbalanced learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/CostSensitive.html">
   2. Cost-sensitive learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/Resampling.html">
   3. Resampling strategies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/Ensembling.html">
   4. Ensemble methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/Imbalanced_RealWorldData.html">
   5. Real-world data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6_ImbalancedLearning/Summary.html">
   6. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  7. Deep learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/Introduction.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/FeedForwardNeuralNetworks.html">
   2. Feed-forward neural network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/Autoencoders.html">
   3. Autoencoders and anomaly detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/SequentialModeling.html">
   4. Sequential models and representation learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/RealWorldData.html">
   5. Real-world data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7_DeepLearning/Summary.html">
   6. Summary
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_References/shared_functions.html">
   1. Shared functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_References/bibliography.html">
   2. Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_5_ModelValidationAndSelection/ValidationStrategies.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Fraud-Detection-Handbook/fraud-detection-handbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Fraud-Detection-Handbook/fraud-detection-handbook/issues/new?title=Issue%20on%20page%20%2FChapter_5_ModelValidationAndSelection/ValidationStrategies.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/Fraud-Detection-Handbook/fraud-detection-handbook/edit/main/Chapter_5_ModelValidationAndSelection/ValidationStrategies.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Fraud-Detection-Handbook/fraud-detection-handbook/main?urlpath=tree/Chapter_5_ModelValidationAndSelection/ValidationStrategies.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/Fraud-Detection-Handbook/fraud-detection-handbook/blob/main/Chapter_5_ModelValidationAndSelection/ValidationStrategies.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-performance-versus-test-performance">
   2.1. Training performance versus test performance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hold-out-validation">
   2.2. Hold-out validation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#repeated-hold-out-validation">
   2.3. Repeated hold-out validation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prequential-validation">
   2.4. Prequential validation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#integration-in-scikit-learn">
   2.5. Integration in Scikit-learn
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prequential-splitting">
     2.5.1. Prequential splitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#card-precision-top-k">
     2.5.2. Card Precision top-k
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#grid-search">
     2.5.3. Grid search
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#integration">
     2.5.4. Integration
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="validation-strategies">
<span id="id1"></span><h1><span class="section-number">2. </span>Validation strategies<a class="headerlink" href="#validation-strategies" title="Permalink to this headline">¶</a></h1>
<p>The purpose of a fraud detection system is to maximize the detection of fraudulent transactions that will occur in the <em>future</em>.</p>
<p>The most straightforward approach for training and evaluating a prediction model for a fraud detection system is illustrated in Fig. 1. For clarity of the illustration, the stream of transaction data is discretized in blocks. A block corresponds to a time period (such as one week or one day). We assume that the prediction model should be updated every new block <span id="id2">[<a class="reference internal" href="../Chapter_References/bibliography.html#id34">DP15</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id33">DPBC+17</a>]</span>.</p>
<p>This is the approach that we used in the section <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html#baseline-fds"><span class="std std-ref">Baseline fraud detection system</span></a>. Blocks corresponded to one week of transaction data. One block of data was used for training, and one block of data for testing. A one-week delay was also used to separate the training and test blocks.</p>
<p>More generally, given a set of past transactions blocks collected up to the current time <span class="math notranslate nohighlight">\(t\)</span>, the purpose of the prediction model is to provide predictions for transactions that will occur in the next block (<em>future</em> transactions, also called <em>test</em> transactions, in yellow) <span id="id3">[<a class="reference internal" href="../Chapter_References/bibliography.html#id34">DP15</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id33">DPBC+17</a>]</span>. The set of blocks that are used for training are the <em>training blocks</em> (in dark blue). Due to the delay in obtaining transaction labels (See the section <a class="reference internal" href="../Chapter_2_Background/FDS.html#fraud-detection-system"><span class="std std-ref">Credit card fraud detection system</span></a>), the most recent transactions usually cannot be used for training (delay period, in light blue) and are removed. Older blocks are also usually discarded, due to concept drift (in light blue, also removed). Let us denote the lengths of the training, delay, and test periods by <span class="math notranslate nohighlight">\(\delta_{train}\)</span>, <span class="math notranslate nohighlight">\(\delta_{delay}\)</span>, and <span class="math notranslate nohighlight">\(\delta_{test}\)</span>, respectively.</p>
<p><img alt="alt text" src="../_images/stream_train.png" /></p>
<div align="center">Fig. 1. The purpose of a prediction model for fraud detection is to provide predictions for transactions that occur in the future (in yellow). The model is trained on a set of past transactions (in dark blue).</div>
<p>The performance of a model on training data is often a bad indicator of the performance on future data <span id="id4">[<a class="reference internal" href="../Chapter_References/bibliography.html#id20">Bis06</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id21">Bon21</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id19">FHT01</a>]</span>. The former is referred to as <em>training performance</em>, and the latter as <em>test performance</em> (that is, the performance of the model when <em>tested</em> on unseen data). In particular, increasing the degree of freedom of a model (such as the depth for a decision tree) always allows to increase the training performance, but usually leads to lower test performances (<em>overfitting</em> phenomenon).</p>
<p>Validation procedures aim at solving this issue by estimating, on past data, the test performance of a prediction model by setting aside a part of them <span id="id5">[<a class="reference internal" href="../Chapter_References/bibliography.html#id81">CTMozetivc20</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id82">GvZliobaiteB+14</a>]</span>. They work by splitting the past labeled data into two sets, the <em>training set</em> and the <em>validation set</em>, that simulate the setting of a real-world fraud detection system. The validation set plays the role of the test set. This is illustrated in Fig. 2.</p>
<p><img alt="alt text" src="../_images/stream_valid.png" /></p>
<div align="center">Fig. 2. A validation procedure simulates on past data the training procedure that will be used to provide predictions on test (unseen) data. It uses the validation set to estimate the performance of the test stage. </div>
<p>In order to best simulate the setup illustrated in Fig. 1, the training and validation sets are separated with the same delay period. The length of the validation set (<span class="math notranslate nohighlight">\(\delta_{valid}\)</span>) is set equal to the length of the test set (<span class="math notranslate nohighlight">\(\delta_{test}\)</span>). The performance of a model on the validation set is used as an estimate of the performance that is expected on the test set.</p>
<p>The validation strategy illustrated in Fig. 2 is called <em>hold-out validation</em> (since part of the available labeled transactions is held out of the training data). Variants of this approach are the <em>repeated hold-out validation</em> and the <em>prequential validation</em>. The former is the same as the <em>hold-out</em> validation except that the procedure is repeated several times using different subsets of the training data. The latter is a variant that repeats hold-out validation by shifting the training and validation sets in the past. Both repeated hold-out and prequential validations allow providing estimates of performances on the test set, together with confidence intervals <span id="id6">[<a class="reference internal" href="../Chapter_References/bibliography.html#id81">CTMozetivc20</a>, <a class="reference internal" href="../Chapter_References/bibliography.html#id82">GvZliobaiteB+14</a>]</span>.</p>
<p>The next sections detail these validation procedures. We first illustrate using simulated data and decision trees that the training performance is a bad estimate of the test performance. We then provide implementations of the hold-out, repeated hold-out, and prequential validations, and discuss their pros and cons.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialization: Load shared functions and simulated data </span>

<span class="c1"># Load shared functions</span>
<span class="o">!</span>curl -O https://raw.githubusercontent.com/Fraud-Detection-Handbook/fraud-detection-handbook/main/Chapter_References/shared_functions.py
<span class="o">%</span><span class="k">run</span> shared_functions.py

<span class="c1"># Get simulated data from Github repository</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;simulated-data-transformed&quot;</span><span class="p">):</span>
    <span class="o">!</span>git clone https://github.com/Fraud-Detection-Handbook/simulated-data-transformed
        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 41751  100 41751    0     0   147k      0 --:--:-- --:--:-- --:--:--  147k
</pre></div>
</div>
</div>
</div>
<div class="section" id="training-performance-versus-test-performance">
<span id="training-vs-test-performances"></span><h2><span class="section-number">2.1. </span>Training performance versus test performance<a class="headerlink" href="#training-performance-versus-test-performance" title="Permalink to this headline">¶</a></h2>
<p>We first illustrate that the training performance is a bad indicator of the test performance. We reuse the same experimental setup as in Chapter 3 - <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html#baseline-fds"><span class="std std-ref">Baseline fraud detection system</span></a>. One week of data is used for training the prediction model, and one week of data for testing the predictions. We rely on a decision tree model, and assess the training and test performances for decision trees with different tree depths, ranging from two to fifty. Performances are assessed in terms of ROC AUC, Average Precision, and Card Precision&#64;100 as was motivated in Chapter 4 - <a class="reference internal" href="../Chapter_4_PerformanceMetrics/Introduction.html#performance-metrics"><span class="std std-ref">Introduction</span></a>.</p>
<p>Let us first load the simulated data, and set the output feature and input features as in the section <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html#baseline-fds-decision-tree"><span class="std std-ref">Model training : Decision tree</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note: We load more data than three weeks, as the experiments in the next sections</span>
<span class="c1"># will require up to three months of data</span>

<span class="c1"># Load data from the 2018-06-11 to the 2018-09-14</span>

<span class="n">DIR_INPUT</span><span class="o">=</span><span class="s1">&#39;simulated-data-transformed/data/&#39;</span> 

<span class="n">BEGIN_DATE</span> <span class="o">=</span> <span class="s2">&quot;2018-06-11&quot;</span>
<span class="n">END_DATE</span> <span class="o">=</span> <span class="s2">&quot;2018-09-14&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load  files&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">time</span> transactions_df=read_from_files(DIR_INPUT, BEGIN_DATE, END_DATE)
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> transactions loaded, containing </span><span class="si">{1}</span><span class="s2"> fraudulent transactions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">),</span><span class="n">transactions_df</span><span class="o">.</span><span class="n">TX_FRAUD</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

<span class="n">output_feature</span><span class="o">=</span><span class="s2">&quot;TX_FRAUD&quot;</span>

<span class="n">input_features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TX_AMOUNT&#39;</span><span class="p">,</span><span class="s1">&#39;TX_DURING_WEEKEND&#39;</span><span class="p">,</span> <span class="s1">&#39;TX_DURING_NIGHT&#39;</span><span class="p">,</span> <span class="s1">&#39;CUSTOMER_ID_NB_TX_1DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;CUSTOMER_ID_AVG_AMOUNT_1DAY_WINDOW&#39;</span><span class="p">,</span> <span class="s1">&#39;CUSTOMER_ID_NB_TX_7DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;CUSTOMER_ID_AVG_AMOUNT_7DAY_WINDOW&#39;</span><span class="p">,</span> <span class="s1">&#39;CUSTOMER_ID_NB_TX_30DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;CUSTOMER_ID_AVG_AMOUNT_30DAY_WINDOW&#39;</span><span class="p">,</span> <span class="s1">&#39;TERMINAL_ID_NB_TX_1DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;TERMINAL_ID_RISK_1DAY_WINDOW&#39;</span><span class="p">,</span> <span class="s1">&#39;TERMINAL_ID_NB_TX_7DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;TERMINAL_ID_RISK_7DAY_WINDOW&#39;</span><span class="p">,</span> <span class="s1">&#39;TERMINAL_ID_NB_TX_30DAY_WINDOW&#39;</span><span class="p">,</span>
       <span class="s1">&#39;TERMINAL_ID_RISK_30DAY_WINDOW&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Load  files
CPU times: user 1.04 s, sys: 778 ms, total: 1.82 s
Wall time: 2.16 s
919767 transactions loaded, containing 8195 fraudulent transactions
</pre></div>
</div>
</div>
</div>
<p>Using one week for training, one week for testing, and one week of delay corresponds to the experimental setup that is illustrated in Fig. 3.</p>
<p><img alt="alt text" src="../_images/stream_train_1block.png" /></p>
<div align="center">Fig. 3. Experimental setup where one week of data is used for training and one week of data for testing, separated by a one week delay. Each block corresponds to one week of data.</div>
<p>Let us set the start of the training period to the 2018-07-25, and the deltas for training, delay, and test to 7 days (one week).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the starting day for the training period, and the deltas</span>
<span class="n">start_date_training</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2018-07-25&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span>
<span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span>
<span class="n">delta_test</span><span class="o">=</span><span class="mi">7</span>
</pre></div>
</div>
</div>
</div>
<p>We define a function <code class="docutils literal notranslate"><span class="pre">get_performances_train_test_sets</span></code> for training a model, and assessing its performances on the training and test sets. The function performs the same steps as those outlined in the section <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html#baseline-fds"><span class="std std-ref">Baseline fraud detection system</span></a>. The four main steps are:</p>
<ul class="simple">
<li><p>Setting the start date for the training period, and the deltas for training, delay and test</p></li>
<li><p>Getting the training and test sets</p></li>
<li><p>Fitting the model and collecting the predictions</p></li>
<li><p>Assessing the performances for both the training and test sets</p></li>
</ul>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_performances_train_test_sets</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span>
                                     <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
                                     <span class="n">start_date_training</span><span class="p">,</span> 
                                     <span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">delta_test</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                     <span class="n">top_k_list</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                                     <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

    <span class="c1"># Get the training and test sets</span>
    <span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span><span class="o">=</span><span class="n">get_train_test_set</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span><span class="n">start_date_training</span><span class="p">,</span>
                                           <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span>
                                           <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span>
                                           <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">)</span>
    
    <span class="c1"># Fit model</span>
    <span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="n">model_and_predictions_dictionary</span> <span class="o">=</span> <span class="n">fit_model_and_get_predictions</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> 
                                                                     <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">)</span>
    <span class="n">execution_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span>
    
    <span class="c1"># Compute fraud detection performances</span>
    <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_test&#39;</span><span class="p">]</span>
    <span class="n">performances_df_test</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">)</span>
    <span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">type_test</span>
    
    <span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_train&#39;</span><span class="p">]</span>
    <span class="n">performances_df_train</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">)</span>
    <span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; Train&#39;</span>
    
    <span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_test</span><span class="p">,</span><span class="n">performances_df_train</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Execution time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">execution_time</span>
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">parameter_summary</span>
    
    <span class="k">return</span> <span class="n">performances_df</span>
</pre></div>
</div>
</div>
</div>
<p>Let us for example compute the test and training accuracies using a decision tree with depth 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">performances_df</span><span class="o">=</span><span class="n">get_performances_train_test_sets</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
                                                 <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
                                                 <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training</span><span class="p">,</span> 
                                                 <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                                 <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                                 <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
                                                 <span class="n">parameter_summary</span><span class="o">=</span><span class="mi">2</span>
                                                <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.763</td>
      <td>0.496</td>
      <td>0.241</td>
      <td>0.802</td>
      <td>0.586</td>
      <td>0.394</td>
      <td>0.451595</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that the performances are the same as those obtained in the section <a class="reference internal" href="../Chapter_3_GettingStarted/BaselineModeling.html#baseline-fds-performances-simulation"><span class="std std-ref">Performances using standard prediction models</span></a>.</p>
<p>We can then compute the performances for varying decision tree depths. Let us vary the decision tree depths from two to fifty, using the following values: <span class="math notranslate nohighlight">\([2,3,4,5,6,7,8,9,10,20,50]\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">list_params</span><span class="p">:</span>
    
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">performances_df</span><span class="o">=</span><span class="n">performances_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">get_performances_train_test_sets</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
                                         <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span> 
                                         <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training</span><span class="p">,</span> 
                                         <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                         <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                         <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>            
                                         <span class="n">parameter_summary</span><span class="o">=</span><span class="n">max_depth</span>
                           <span class="p">)</span>
    <span class="p">)</span>
    
<span class="n">performances_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.763</td>
      <td>0.496</td>
      <td>0.241</td>
      <td>0.802</td>
      <td>0.586</td>
      <td>0.394</td>
      <td>0.468689</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.795</td>
      <td>0.562</td>
      <td>0.267</td>
      <td>0.815</td>
      <td>0.615</td>
      <td>0.409</td>
      <td>0.582330</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.802</td>
      <td>0.570</td>
      <td>0.269</td>
      <td>0.829</td>
      <td>0.635</td>
      <td>0.411</td>
      <td>0.550253</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.814</td>
      <td>0.581</td>
      <td>0.280</td>
      <td>0.835</td>
      <td>0.649</td>
      <td>0.419</td>
      <td>0.580715</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.817</td>
      <td>0.588</td>
      <td>0.280</td>
      <td>0.842</td>
      <td>0.662</td>
      <td>0.421</td>
      <td>0.642127</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.793</td>
      <td>0.542</td>
      <td>0.254</td>
      <td>0.876</td>
      <td>0.679</td>
      <td>0.427</td>
      <td>0.666566</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.786</td>
      <td>0.546</td>
      <td>0.257</td>
      <td>0.884</td>
      <td>0.717</td>
      <td>0.436</td>
      <td>0.727614</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756</td>
      <td>0.499</td>
      <td>0.246</td>
      <td>0.896</td>
      <td>0.737</td>
      <td>0.437</td>
      <td>0.773424</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.750</td>
      <td>0.484</td>
      <td>0.244</td>
      <td>0.901</td>
      <td>0.756</td>
      <td>0.440</td>
      <td>0.782423</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.739</td>
      <td>0.392</td>
      <td>0.243</td>
      <td>0.974</td>
      <td>0.907</td>
      <td>0.506</td>
      <td>1.194687</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.788</td>
      <td>0.309</td>
      <td>0.243</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.576</td>
      <td>1.411543</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For better visualization of the results, let us plot the resulting performances in terms of AUC ROC, AP, and CP&#64;100, as a function of the decision tree depth.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the performance plot for a single performance metric</span>
<span class="k">def</span> <span class="nf">get_performance_plot</span><span class="p">(</span><span class="n">performances_df</span><span class="p">,</span> 
                         <span class="n">ax</span><span class="p">,</span> 
                         <span class="n">performance_metric</span><span class="p">,</span> 
                         <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Train&#39;</span><span class="p">],</span> 
                         <span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#2F4D7E&#39;</span><span class="p">],</span>
                         <span class="n">parameter_name</span><span class="o">=</span><span class="s2">&quot;Tree maximum depth&quot;</span><span class="p">,</span>
                         <span class="n">summary_performances</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1"># expe_type_list is the list of type of experiments, typically containing &#39;Test&#39;, &#39;Train&#39;, or &#39;Valid&#39;</span>
    <span class="c1"># For all types of experiments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expe_type_list</span><span class="p">)):</span>
    
        <span class="c1"># Column in performances_df for which to retrieve the data </span>
        <span class="n">performance_metric_expe_type</span><span class="o">=</span><span class="n">performance_metric</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">expe_type_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
        <span class="c1"># Plot data on graph</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">],</span> <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metric_expe_type</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">expe_type_color_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">expe_type_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="c1"># If performances_df contains confidence intervals, add them to the graph</span>
        <span class="k">if</span> <span class="n">performance_metric_expe_type</span><span class="o">+</span><span class="s1">&#39; Std&#39;</span> <span class="ow">in</span> <span class="n">performances_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        
            <span class="n">conf_min</span> <span class="o">=</span> <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metric_expe_type</span><span class="p">]</span>\
                        <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metric_expe_type</span><span class="o">+</span><span class="s1">&#39; Std&#39;</span><span class="p">]</span>
            <span class="n">conf_max</span> <span class="o">=</span> <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metric_expe_type</span><span class="p">]</span>\
                        <span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metric_expe_type</span><span class="o">+</span><span class="s1">&#39; Std&#39;</span><span class="p">]</span>
    
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">],</span> <span class="n">conf_min</span><span class="p">,</span> <span class="n">conf_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">expe_type_color_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>

    <span class="c1"># If summary_performances table is present, adds vertical dashed bar for best estimated parameter </span>
    <span class="k">if</span> <span class="n">summary_performances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_estimated_parameter</span><span class="o">=</span><span class="n">summary_performances</span><span class="p">[</span><span class="n">performance_metric</span><span class="p">][[</span><span class="s1">&#39;Best estimated parameters ($k^*$)&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_estimated_performance</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">summary_performances</span><span class="p">[</span><span class="n">performance_metric</span><span class="p">][[</span><span class="s1">&#39;Validation performance&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+/-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">best_estimated_parameter</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">best_estimated_performance</span><span class="p">,</span>
                  <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
    
    <span class="c1"># Set title, and x and y axes labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">performance_metric</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">performance_metric</span><span class="p">)</span>

<span class="c1"># Get the performance plots for a set of performance metric</span>
<span class="k">def</span> <span class="nf">get_performances_plots</span><span class="p">(</span><span class="n">performances_df</span><span class="p">,</span> 
                           <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                           <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Train&#39;</span><span class="p">],</span> <span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#2F4D7E&#39;</span><span class="p">],</span>
                           <span class="n">parameter_name</span><span class="o">=</span><span class="s2">&quot;Tree maximum depth&quot;</span><span class="p">,</span>
                           <span class="n">summary_performances</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1"># Create as many graphs as there are performance metrics to display</span>
    <span class="n">n_performance_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">performance_metrics_list</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_performance_metrics</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_performance_metrics</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="c1"># Plot performance metric for each metric in performance_metrics_list</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_performance_metrics</span><span class="p">):</span>
    
        <span class="n">get_performance_plot</span><span class="p">(</span><span class="n">performances_df</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">performance_metric</span><span class="o">=</span><span class="n">performance_metrics_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                             <span class="n">expe_type_list</span><span class="o">=</span><span class="n">expe_type_list</span><span class="p">,</span> 
                             <span class="n">expe_type_color_list</span><span class="o">=</span><span class="n">expe_type_color_list</span><span class="p">,</span>
                             <span class="n">parameter_name</span><span class="o">=</span><span class="n">parameter_name</span><span class="p">,</span>
                             <span class="n">summary_performances</span><span class="o">=</span><span class="n">summary_performances</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">n_performance_metrics</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> 
                                       <span class="n">labels</span><span class="o">=</span><span class="n">expe_type_list</span><span class="p">,</span> 
                                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Type set&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                        <span class="n">hspace</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span><span class="n">performances_df</span><span class="p">,</span> 
                       <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                       <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Train&#39;</span><span class="p">],</span><span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#2F4D7E&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_16_0.png" src="../_images/ValidationStrategies_16_0.png" />
</div>
</div>
<p>The training performance is plotted in blue, and the test performance in green. The graph clearly illustrates the <em>overfitting</em> phenomenon: The training performance keeps increasing with the tree depth and reaches a perfect fit, i.e. the highest possible AUC ROC/AP, for a depth of fifty. The test performance however peaks at a depth of 6. A depth of 6 is therefore the depth that maximizes the performance on the test set when a decision tree is used as a prediction model.</p>
<p>Let us also recall that the Card Precision&#64;100 is the metric that is of highest interest for fraud investigators. It is worth noting that the AUC ROC on the test set has a different dynamic than the CP&#64;100: For the highest tree depth of fifty, the accuracy in terms of AUC ROC increases, whereas the CP&#64;100 remains low. This illustrates experimentally that the AUC ROC is not a well-suited metric for fraud investigators.</p>
</div>
<div class="section" id="hold-out-validation">
<span id="id7"></span><h2><span class="section-number">2.2. </span>Hold-out validation<a class="headerlink" href="#hold-out-validation" title="Permalink to this headline">¶</a></h2>
<p>As illustrated above, the training performance does not provide guidance on how to select the prediction model that performs best on test data. Let us also recall that the test data cannot be used to estimate the prediction model at the time of training, since it has not been collecting yet.</p>
<p>A simple way to anticipate the performance of the model at the test stage is by simulating the setup as above, but shifted in the past, using only the historical data available at the time of training. The most recent block with labeled data is used as a <em>validation set</em>. The training set consists of the blocks of transactions that precedes the validation set, with a delay block in between. The validation setup is illustrated in Fig. 4.</p>
<p><img alt="alt text" src="../_images/stream_valid_1block.png" /></p>
<div align="center">Fig. 4. Hold-out validation: The test performance is estimated using a validation set. The validation set has the same length as the test set.</div>
<p>This validation strategy is called <em>hold-out validation</em> since part of the historical data is held-out from the training set.</p>
<p>Since hold-out validation only shifts the experimental setup, the same code as in the previous section can be reused. The only thing to change is to shift the training starting date in the past.</p>
<p>Let us therefore shift the starting date of the training set by two blocks (the deltas of the delay and validation periods), and compute the performance for the validation set using the <code class="docutils literal notranslate"><span class="pre">get_performances_train_test_sets</span></code> function. As an example, we can start with a a decision tree of depth 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">delta_valid</span> <span class="o">=</span> <span class="n">delta_test</span>

<span class="n">start_date_training_with_valid</span> <span class="o">=</span> <span class="n">start_date_training</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="p">(</span><span class="n">delta_delay</span><span class="o">+</span><span class="n">delta_valid</span><span class="p">))</span>

<span class="n">performances_df_validation</span><span class="o">=</span><span class="n">get_performances_train_test_sets</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> 
                                                            <span class="n">classifier</span><span class="p">,</span> 
                                                            <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
                                                            <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
                                                            <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                                            <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                                            <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
                                                            <span class="n">type_test</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_validation</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.775</td>
      <td>0.524</td>
      <td>0.243</td>
      <td>0.791</td>
      <td>0.577</td>
      <td>0.399</td>
      <td>0.459617</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us compare the results with those obtained in the previous section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.763</td>
      <td>0.496</td>
      <td>0.241</td>
      <td>0.802</td>
      <td>0.586</td>
      <td>0.394</td>
      <td>0.468689</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The performances obtained on the validation set are very similar to those obtained on the test set, illustrating the ability of the validation set to provide estimates of the expected performances on the test set.</p>
<p>Let us then compute the expected performances for different depths of decision trees (with values <span class="math notranslate nohighlight">\([2,3,4,5,6,7,8,9,10,20,50]\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="n">performances_df_validation</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">list_params</span><span class="p">:</span>
    
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">performances_df_validation</span><span class="o">=</span><span class="n">performances_df_validation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">get_performances_train_test_sets</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> 
                                         <span class="n">classifier</span><span class="p">,</span>
                                         <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
                                         <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
                                         <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                         <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                         <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span> 
                                         <span class="n">type_test</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="n">max_depth</span>
                                        <span class="p">)</span>
    <span class="p">)</span>
    
<span class="n">performances_df_validation</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_validation</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.775</td>
      <td>0.524</td>
      <td>0.243</td>
      <td>0.791</td>
      <td>0.577</td>
      <td>0.399</td>
      <td>0.471099</td>
      <td>2</td>
      <td>0.763</td>
      <td>0.496</td>
      <td>0.241</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.778</td>
      <td>0.538</td>
      <td>0.247</td>
      <td>0.803</td>
      <td>0.604</td>
      <td>0.413</td>
      <td>0.551226</td>
      <td>3</td>
      <td>0.795</td>
      <td>0.562</td>
      <td>0.267</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.784</td>
      <td>0.535</td>
      <td>0.249</td>
      <td>0.815</td>
      <td>0.624</td>
      <td>0.419</td>
      <td>0.565738</td>
      <td>4</td>
      <td>0.802</td>
      <td>0.570</td>
      <td>0.269</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.791</td>
      <td>0.533</td>
      <td>0.257</td>
      <td>0.824</td>
      <td>0.642</td>
      <td>0.430</td>
      <td>0.573082</td>
      <td>5</td>
      <td>0.814</td>
      <td>0.581</td>
      <td>0.280</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.798</td>
      <td>0.532</td>
      <td>0.257</td>
      <td>0.835</td>
      <td>0.659</td>
      <td>0.431</td>
      <td>0.725964</td>
      <td>6</td>
      <td>0.817</td>
      <td>0.588</td>
      <td>0.280</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.804</td>
      <td>0.537</td>
      <td>0.256</td>
      <td>0.848</td>
      <td>0.671</td>
      <td>0.434</td>
      <td>0.782774</td>
      <td>7</td>
      <td>0.793</td>
      <td>0.542</td>
      <td>0.254</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.796</td>
      <td>0.524</td>
      <td>0.253</td>
      <td>0.850</td>
      <td>0.691</td>
      <td>0.437</td>
      <td>0.735238</td>
      <td>8</td>
      <td>0.786</td>
      <td>0.546</td>
      <td>0.257</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.781</td>
      <td>0.473</td>
      <td>0.249</td>
      <td>0.852</td>
      <td>0.699</td>
      <td>0.437</td>
      <td>0.900177</td>
      <td>9</td>
      <td>0.756</td>
      <td>0.499</td>
      <td>0.246</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.802</td>
      <td>0.466</td>
      <td>0.251</td>
      <td>0.879</td>
      <td>0.706</td>
      <td>0.439</td>
      <td>0.823850</td>
      <td>10</td>
      <td>0.750</td>
      <td>0.484</td>
      <td>0.244</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.775</td>
      <td>0.445</td>
      <td>0.259</td>
      <td>0.967</td>
      <td>0.849</td>
      <td>0.481</td>
      <td>1.233804</td>
      <td>20</td>
      <td>0.739</td>
      <td>0.392</td>
      <td>0.243</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.820</td>
      <td>0.324</td>
      <td>0.259</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.571</td>
      <td>1.387409</td>
      <td>50</td>
      <td>0.788</td>
      <td>0.309</td>
      <td>0.243</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For better visualization, let us plot the validation and test performances in terms of AUC ROC, AP, and CP&#64;100, as a function of the decision tree depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_validation</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_validation</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_validation</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span><span class="n">performances_df_validation</span><span class="p">,</span> 
                       <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                       <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Validation&#39;</span><span class="p">],</span><span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_29_0.png" src="../_images/ValidationStrategies_29_0.png" />
</div>
</div>
<p>The plots show interesting insights into the ability of the validation set to provide both a good performance estimate for the test set and a way to select the best model. First, it should be noted that the performances obtained on both sets differ in terms of exact values, but tend to follow similar dynamics. Exact matches in terms of performances cannot be expected, since different sets are used for training and testing.</p>
<p>The performances obtained on the validation set however provide guidance in selecting the tree depths that can maximize the performance on the test set. This is particularly true for the performance in terms of AP, where the optimal depth is in the range 3 to 8.</p>
<p>The AUC ROC and CP&#64;100 however exhibit more discrepancies, and appear less well suited for determining the optimal tree depth. In particular, their value is maximized on the validation set for a decision tree depth of 50, whereas such a tree depth provides low performance on the test set.</p>
</div>
<div class="section" id="repeated-hold-out-validation">
<h2><span class="section-number">2.3. </span>Repeated hold-out validation<a class="headerlink" href="#repeated-hold-out-validation" title="Permalink to this headline">¶</a></h2>
<p>Prediction models, and their performances, are often sensitive to the data used for training. Slightly changing the training set may result in different prediction models and performances.</p>
<p>An alternative to the hold-out validation procedures consists in training different prediction models with random samples of the training data. This allows to get different estimates of the validation error, therefore providing confidence intervals on the expected performances, instead of a single estimate. The procedure is referred to as the <em>repeated hold-out</em> validation procedure.</p>
<p>Repeated hold-out validation can be implemented by slightly amending the <code class="docutils literal notranslate"><span class="pre">get_performances_train_test_sets</span></code> function defined above. The function takes two more parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_folds</span></code>: The number of random subsets that will be used to train the different prediction models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sampling_ratio</span></code>: The proportion of data that will be randomly sampled each time from the training data.</p></li>
</ul>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">repeated_holdout_validation</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
                                <span class="n">start_date_training</span><span class="p">,</span> 
                                <span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">delta_test</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                <span class="n">sampling_ratio</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                <span class="n">top_k_list</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                                <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

    <span class="n">performances_df_folds</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    
    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_folds</span><span class="p">):</span>
        
        <span class="c1"># Get the training and test sets</span>
        <span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span><span class="o">=</span><span class="n">get_train_test_set</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                                               <span class="n">start_date_training</span><span class="p">,</span>
                                               <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span><span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span><span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
                                               <span class="n">sampling_ratio</span><span class="o">=</span><span class="n">sampling_ratio</span><span class="p">,</span>
                                               <span class="n">random_state</span><span class="o">=</span><span class="n">fold</span><span class="p">)</span>
    
        
        <span class="c1"># Fit model  </span>
        <span class="n">model_and_predictions_dictionary</span> <span class="o">=</span> <span class="n">fit_model_and_get_predictions</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> 
                                                                         <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">)</span>
        
        <span class="c1"># Compute fraud detection performances</span>
        <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_test&#39;</span><span class="p">]</span>
        <span class="n">performances_df_test</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">)</span>
        <span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">type_test</span>
        
        <span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_train&#39;</span><span class="p">]</span>
        <span class="n">performances_df_train</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">)</span>
        <span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; Train&#39;</span>
    
        <span class="n">performances_df_folds</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_test</span><span class="p">,</span><span class="n">performances_df_train</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">execution_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span>
    
    <span class="n">performances_df_folds_mean</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">performances_df_folds_mean</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">performances_df_folds_mean</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">performances_df_folds_std</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_folds_std</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s2">&quot; Std&quot;</span>
    <span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_folds_mean</span><span class="p">,</span><span class="n">performances_df_folds_std</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Execution time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">execution_time</span>
    
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">parameter_summary</span>
    
    <span class="k">return</span> <span class="n">performances_df</span><span class="p">,</span> <span class="n">performances_df_folds</span>
</pre></div>
</div>
</div>
</div>
<p>Let us for example compute the validation accuracy with a decision tree of depth 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">performances_df_repeated_holdout_summary</span><span class="p">,</span> \
<span class="n">performances_df_repeated_holdout_folds</span><span class="o">=</span><span class="n">repeated_holdout_validation</span><span class="p">(</span>
    <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
    <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
    <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
    <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
    <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span> 
    <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">sampling_ratio</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">repeated_holdout_validation</span></code> function returns two DataFrames:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">performances_df_repeated_holdout_summary</span></code>: Summary of performance metrics over all folds, in terms of mean and standard variance for each performance metric.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accuracy_df_repeated_holdout_folds</span></code>: Performance metrics obtained in each fold</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_repeated_holdout_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.776</td>
      <td>0.51875</td>
      <td>0.24475</td>
      <td>0.79475</td>
      <td>0.57575</td>
      <td>0.2985</td>
      <td>0.001225</td>
      <td>0.006495</td>
      <td>0.001785</td>
      <td>0.003961</td>
      <td>0.008871</td>
      <td>0.009341</td>
      <td>3.287545</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_repeated_holdout_folds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.778</td>
      <td>0.514</td>
      <td>0.247</td>
      <td>0.797</td>
      <td>0.569</td>
      <td>0.311</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.776</td>
      <td>0.511</td>
      <td>0.246</td>
      <td>0.798</td>
      <td>0.572</td>
      <td>0.304</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.775</td>
      <td>0.523</td>
      <td>0.243</td>
      <td>0.788</td>
      <td>0.571</td>
      <td>0.289</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.775</td>
      <td>0.527</td>
      <td>0.243</td>
      <td>0.796</td>
      <td>0.591</td>
      <td>0.290</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us then compute the expected performances for different depths of decision trees (with values <span class="math notranslate nohighlight">\([2,3,4,5,6,7,8,9,10,20,50]\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="n">performances_df_repeated_holdout</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">list_params</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing performances for a decision tree with max_depth=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>
    
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">performances_df_repeated_holdout</span><span class="o">=</span><span class="n">performances_df_repeated_holdout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">repeated_holdout_validation</span><span class="p">(</span>
            <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
            <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
            <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
            <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
            <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
            <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">sampling_ratio</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="n">max_depth</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    
<span class="n">performances_df_repeated_holdout</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total execution time: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing performances for a decision tree with max_depth=2
Computing performances for a decision tree with max_depth=3
Computing performances for a decision tree with max_depth=4
Computing performances for a decision tree with max_depth=5
Computing performances for a decision tree with max_depth=6
Computing performances for a decision tree with max_depth=7
Computing performances for a decision tree with max_depth=8
Computing performances for a decision tree with max_depth=9
Computing performances for a decision tree with max_depth=10
Computing performances for a decision tree with max_depth=20
Computing performances for a decision tree with max_depth=50
Total execution time: 39.19s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_repeated_holdout</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.77600</td>
      <td>0.51875</td>
      <td>0.24475</td>
      <td>0.79475</td>
      <td>0.57575</td>
      <td>0.29850</td>
      <td>0.001225</td>
      <td>0.006495</td>
      <td>0.001785</td>
      <td>0.003961</td>
      <td>0.008871</td>
      <td>0.009341</td>
      <td>3.002673</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.78200</td>
      <td>0.53800</td>
      <td>0.24900</td>
      <td>0.80650</td>
      <td>0.60525</td>
      <td>0.30675</td>
      <td>0.002449</td>
      <td>0.003937</td>
      <td>0.001414</td>
      <td>0.002958</td>
      <td>0.003832</td>
      <td>0.007189</td>
      <td>2.892724</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.78550</td>
      <td>0.54100</td>
      <td>0.25125</td>
      <td>0.81425</td>
      <td>0.62325</td>
      <td>0.31075</td>
      <td>0.006185</td>
      <td>0.007649</td>
      <td>0.006180</td>
      <td>0.004969</td>
      <td>0.006220</td>
      <td>0.007790</td>
      <td>3.032751</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.78200</td>
      <td>0.52900</td>
      <td>0.24825</td>
      <td>0.82025</td>
      <td>0.63625</td>
      <td>0.31175</td>
      <td>0.008515</td>
      <td>0.014036</td>
      <td>0.003700</td>
      <td>0.007529</td>
      <td>0.009575</td>
      <td>0.008871</td>
      <td>3.156154</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.78350</td>
      <td>0.51725</td>
      <td>0.25225</td>
      <td>0.82875</td>
      <td>0.64800</td>
      <td>0.31825</td>
      <td>0.007018</td>
      <td>0.006300</td>
      <td>0.005761</td>
      <td>0.007395</td>
      <td>0.008062</td>
      <td>0.006759</td>
      <td>3.217496</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.78450</td>
      <td>0.51725</td>
      <td>0.25175</td>
      <td>0.83825</td>
      <td>0.66375</td>
      <td>0.32250</td>
      <td>0.005025</td>
      <td>0.015833</td>
      <td>0.003491</td>
      <td>0.002773</td>
      <td>0.010779</td>
      <td>0.005500</td>
      <td>3.332991</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.78700</td>
      <td>0.51150</td>
      <td>0.25125</td>
      <td>0.84625</td>
      <td>0.67950</td>
      <td>0.32400</td>
      <td>0.009274</td>
      <td>0.020267</td>
      <td>0.002681</td>
      <td>0.002861</td>
      <td>0.003905</td>
      <td>0.006285</td>
      <td>3.418987</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.78400</td>
      <td>0.50150</td>
      <td>0.24850</td>
      <td>0.85625</td>
      <td>0.69000</td>
      <td>0.32625</td>
      <td>0.010700</td>
      <td>0.024005</td>
      <td>0.003841</td>
      <td>0.011584</td>
      <td>0.005244</td>
      <td>0.005890</td>
      <td>3.500675</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.79675</td>
      <td>0.49800</td>
      <td>0.25075</td>
      <td>0.87400</td>
      <td>0.70425</td>
      <td>0.33000</td>
      <td>0.015352</td>
      <td>0.024321</td>
      <td>0.003112</td>
      <td>0.009192</td>
      <td>0.007562</td>
      <td>0.008832</td>
      <td>3.656681</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.80125</td>
      <td>0.45425</td>
      <td>0.26300</td>
      <td>0.97150</td>
      <td>0.86500</td>
      <td>0.37025</td>
      <td>0.014289</td>
      <td>0.030938</td>
      <td>0.004637</td>
      <td>0.008789</td>
      <td>0.016837</td>
      <td>0.011099</td>
      <td>4.784067</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.81550</td>
      <td>0.33675</td>
      <td>0.26000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.42900</td>
      <td>0.005408</td>
      <td>0.028146</td>
      <td>0.002828</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.004062</td>
      <td>5.121476</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For better vizualization, let us plot the validation and test accuracies in terms of AUC ROC, AP, and CP&#64;100 as a function of the decision tree depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.763</td>
      <td>0.496</td>
      <td>0.241</td>
      <td>0.802</td>
      <td>0.586</td>
      <td>0.394</td>
      <td>0.468689</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.795</td>
      <td>0.562</td>
      <td>0.267</td>
      <td>0.815</td>
      <td>0.615</td>
      <td>0.409</td>
      <td>0.582330</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.802</td>
      <td>0.570</td>
      <td>0.269</td>
      <td>0.829</td>
      <td>0.635</td>
      <td>0.411</td>
      <td>0.550253</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.814</td>
      <td>0.581</td>
      <td>0.280</td>
      <td>0.835</td>
      <td>0.649</td>
      <td>0.419</td>
      <td>0.580715</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.817</td>
      <td>0.588</td>
      <td>0.280</td>
      <td>0.842</td>
      <td>0.662</td>
      <td>0.421</td>
      <td>0.642127</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.793</td>
      <td>0.542</td>
      <td>0.254</td>
      <td>0.876</td>
      <td>0.679</td>
      <td>0.427</td>
      <td>0.666566</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.786</td>
      <td>0.546</td>
      <td>0.257</td>
      <td>0.884</td>
      <td>0.717</td>
      <td>0.436</td>
      <td>0.727614</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.756</td>
      <td>0.499</td>
      <td>0.246</td>
      <td>0.896</td>
      <td>0.737</td>
      <td>0.437</td>
      <td>0.773424</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.750</td>
      <td>0.484</td>
      <td>0.244</td>
      <td>0.901</td>
      <td>0.756</td>
      <td>0.440</td>
      <td>0.782423</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.739</td>
      <td>0.392</td>
      <td>0.243</td>
      <td>0.974</td>
      <td>0.907</td>
      <td>0.506</td>
      <td>1.194687</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.788</td>
      <td>0.309</td>
      <td>0.243</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.576</td>
      <td>1.411543</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_repeated_holdout</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_repeated_holdout</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_repeated_holdout</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span>
    <span class="n">performances_df_repeated_holdout</span><span class="p">,</span> 
    <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
    <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Validation&#39;</span><span class="p">],</span><span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_44_0.png" src="../_images/ValidationStrategies_44_0.png" />
</div>
</div>
<p>The repeated hold-out validation offers a better view of the expected performances, by providing confidence intervals. Qualitatively, the results are similar to the hold-out validation. The AP provides the most accurate proxy to the expected performance on the test set. The AUC ROC and CP&#64;100 provide poorer estimates of the test performance.</p>
</div>
<div class="section" id="prequential-validation">
<span id="id8"></span><h2><span class="section-number">2.4. </span>Prequential validation<a class="headerlink" href="#prequential-validation" title="Permalink to this headline">¶</a></h2>
<p>The repeated hold-out validation relies on random subsets of the same training data to build prediction models. A limitation of this approach is that it reduces the expected performances of the models, as only subsets of data are used for training.</p>
<p>An alternative validation procedure consists in using training sets of similar sizes, taken from older historical data. The scheme is called <em>prequential validation</em>, and is illustrated in Fig. 5. Each fold shifts the training and validation sets by one block in the past.</p>
<p><img alt="alt text" src="../_images/stream_prequential_1block.png" /></p>
<div align="center">Fig. 5. Prequential validation: Each fold shifts the training and validation sets by one block in the past. The validation set has the same length as the test.</div>
<p>The implementation is similar than the repeated hold-out validation. The only difference is that, for each fold, the starting dates for the training and validation sets are shifted by one block. The implementation is provided below, with the function <code class="docutils literal notranslate"><span class="pre">prequential_validation</span></code>.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prequential_validation</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
                           <span class="n">start_date_training</span><span class="p">,</span> 
                           <span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                           <span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                           <span class="n">delta_assessment</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                           <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                           <span class="n">top_k_list</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                           <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

    <span class="n">performances_df_folds</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    
    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_folds</span><span class="p">):</span>
        
        <span class="n">start_date_training_fold</span><span class="o">=</span><span class="n">start_date_training</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">fold</span><span class="o">*</span><span class="n">delta_assessment</span><span class="p">)</span>
        
        <span class="c1"># Get the training and test sets</span>
        <span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span><span class="o">=</span><span class="n">get_train_test_set</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                                               <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_fold</span><span class="p">,</span>
                                               <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span>
                                               <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span>
                                               <span class="n">delta_test</span><span class="o">=</span><span class="n">delta_assessment</span><span class="p">)</span>
    
        <span class="c1"># Fit model</span>
        <span class="n">model_and_predictions_dictionary</span> <span class="o">=</span> <span class="n">fit_model_and_get_predictions</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> 
                                                                     <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">)</span>
        
        <span class="c1"># Compute fraud detection performances    </span>
        <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_test&#39;</span><span class="p">]</span>
        <span class="n">performances_df_test</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">type_test</span>
        
        <span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">model_and_predictions_dictionary</span><span class="p">[</span><span class="s1">&#39;predictions_train&#39;</span><span class="p">]</span>
        <span class="n">performances_df_train</span><span class="o">=</span><span class="n">performance_assessment</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">top_k_list</span><span class="o">=</span><span class="n">top_k_list</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">&#39; Train&#39;</span>
    
        <span class="n">performances_df_folds</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_test</span><span class="p">,</span><span class="n">performances_df_train</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">execution_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span>
    
    <span class="n">performances_df_folds_mean</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">=</span><span class="n">performances_df_folds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">performances_df_folds_mean</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">performances_df_folds_mean</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">performances_df_folds_std</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">performances_df_folds_std</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">performances_df_folds_std</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s2">&quot; Std&quot;</span>
    <span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_folds_mean</span><span class="p">,</span><span class="n">performances_df_folds_std</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Execution time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">execution_time</span>
    
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">parameter_summary</span>
    
    <span class="k">return</span> <span class="n">performances_df</span><span class="p">,</span> <span class="n">performances_df_folds</span>
</pre></div>
</div>
</div>
</div>
<p>Let us for example compute the validation performance with a decision tree of depth 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">performances_df_prequential_summary</span><span class="p">,</span> <span class="n">performances_df_prequential_folds</span><span class="o">=</span><span class="n">prequential_validation</span><span class="p">(</span>
    <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
    <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
    <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
    <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
    <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_valid</span><span class="p">,</span> 
    <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As with the function <code class="docutils literal notranslate"><span class="pre">repeated_holdout_validation</span></code>, the <code class="docutils literal notranslate"><span class="pre">prequential_validation</span></code> function returns two DataFrames:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">performances_df_prequential_summary</span></code>: Summary of performance metrics over all folds, in terms of mean and standard variance for each performance metric.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">performances_df_prequential_folds</span></code>: Performance metrics obtained in each fold</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.790786</td>
      <td>0.549767</td>
      <td>0.256429</td>
      <td>0.804231</td>
      <td>0.593561</td>
      <td>0.4025</td>
      <td>0.012035</td>
      <td>0.022134</td>
      <td>0.014481</td>
      <td>0.013359</td>
      <td>0.018224</td>
      <td>0.040474</td>
      <td>3.364997</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential_folds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.775012</td>
      <td>0.523548</td>
      <td>0.242857</td>
      <td>0.791004</td>
      <td>0.576732</td>
      <td>0.398571</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.808739</td>
      <td>0.584663</td>
      <td>0.242857</td>
      <td>0.791234</td>
      <td>0.576985</td>
      <td>0.347143</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.791405</td>
      <td>0.542531</td>
      <td>0.262857</td>
      <td>0.813726</td>
      <td>0.599954</td>
      <td>0.402857</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.787988</td>
      <td>0.548326</td>
      <td>0.277143</td>
      <td>0.820960</td>
      <td>0.620572</td>
      <td>0.461429</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us then compute the expected performances for different depths of decision trees, ranging from <span class="math notranslate nohighlight">\([2,3,4,5,6,7,8,9,10,20,50]\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">performances_df_prequential</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">list_params</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing performances for a decision tree with max_depth=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>
    
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">performances_df_prequential</span><span class="o">=</span><span class="n">performances_df_prequential</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">prequential_validation</span><span class="p">(</span>
            <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span>
            <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span> 
            <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
            <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
            <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
            <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="n">max_depth</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    
<span class="n">performances_df_prequential</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total execution time: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing performances for a decision tree with max_depth=2
Computing performances for a decision tree with max_depth=3
Computing performances for a decision tree with max_depth=4
Computing performances for a decision tree with max_depth=5
Computing performances for a decision tree with max_depth=6
Computing performances for a decision tree with max_depth=7
Computing performances for a decision tree with max_depth=8
Computing performances for a decision tree with max_depth=9
Computing performances for a decision tree with max_depth=10
Computing performances for a decision tree with max_depth=20
Computing performances for a decision tree with max_depth=50
Total execution time: 52.82s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.790786</td>
      <td>0.549767</td>
      <td>0.256429</td>
      <td>0.804231</td>
      <td>0.593561</td>
      <td>0.402500</td>
      <td>0.012035</td>
      <td>0.022134</td>
      <td>0.014481</td>
      <td>0.013359</td>
      <td>0.018224</td>
      <td>0.040474</td>
      <td>3.666392</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.802717</td>
      <td>0.573414</td>
      <td>0.267143</td>
      <td>0.818140</td>
      <td>0.623562</td>
      <td>0.421429</td>
      <td>0.017607</td>
      <td>0.027186</td>
      <td>0.016067</td>
      <td>0.011437</td>
      <td>0.016412</td>
      <td>0.032214</td>
      <td>3.414093</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.800690</td>
      <td>0.554134</td>
      <td>0.264286</td>
      <td>0.825978</td>
      <td>0.644766</td>
      <td>0.426429</td>
      <td>0.017878</td>
      <td>0.038293</td>
      <td>0.014321</td>
      <td>0.009928</td>
      <td>0.018337</td>
      <td>0.034144</td>
      <td>3.765976</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.804218</td>
      <td>0.546094</td>
      <td>0.267857</td>
      <td>0.831289</td>
      <td>0.657368</td>
      <td>0.431429</td>
      <td>0.016505</td>
      <td>0.042197</td>
      <td>0.013869</td>
      <td>0.007867</td>
      <td>0.016387</td>
      <td>0.029881</td>
      <td>3.788764</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.798603</td>
      <td>0.537006</td>
      <td>0.264643</td>
      <td>0.839032</td>
      <td>0.669597</td>
      <td>0.432143</td>
      <td>0.024225</td>
      <td>0.037056</td>
      <td>0.008474</td>
      <td>0.002592</td>
      <td>0.012448</td>
      <td>0.028383</td>
      <td>4.170064</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.795636</td>
      <td>0.530609</td>
      <td>0.262500</td>
      <td>0.846446</td>
      <td>0.681837</td>
      <td>0.436429</td>
      <td>0.023144</td>
      <td>0.040323</td>
      <td>0.006804</td>
      <td>0.005559</td>
      <td>0.008949</td>
      <td>0.026351</td>
      <td>4.368153</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.795142</td>
      <td>0.516246</td>
      <td>0.260714</td>
      <td>0.859548</td>
      <td>0.694885</td>
      <td>0.440000</td>
      <td>0.023081</td>
      <td>0.033545</td>
      <td>0.009715</td>
      <td>0.008063</td>
      <td>0.009498</td>
      <td>0.031380</td>
      <td>4.966671</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.785849</td>
      <td>0.505189</td>
      <td>0.260357</td>
      <td>0.864869</td>
      <td>0.717259</td>
      <td>0.447500</td>
      <td>0.026249</td>
      <td>0.040393</td>
      <td>0.009813</td>
      <td>0.011527</td>
      <td>0.015346</td>
      <td>0.028453</td>
      <td>4.757738</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.786784</td>
      <td>0.493543</td>
      <td>0.257143</td>
      <td>0.887622</td>
      <td>0.727672</td>
      <td>0.448571</td>
      <td>0.031165</td>
      <td>0.048307</td>
      <td>0.009949</td>
      <td>0.011532</td>
      <td>0.018154</td>
      <td>0.028962</td>
      <td>5.247802</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.780408</td>
      <td>0.450980</td>
      <td>0.264286</td>
      <td>0.964275</td>
      <td>0.862459</td>
      <td>0.496786</td>
      <td>0.022168</td>
      <td>0.031413</td>
      <td>0.007890</td>
      <td>0.007512</td>
      <td>0.014831</td>
      <td>0.031483</td>
      <td>6.802245</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.822564</td>
      <td>0.341818</td>
      <td>0.265714</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.578571</td>
      <td>0.013407</td>
      <td>0.026227</td>
      <td>0.008512</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.028732</td>
      <td>7.768848</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us plot the validation and test performances in terms of AUC ROC, AP, and CP&#64;100, as a function of the decision tree depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span><span class="n">performances_df_prequential</span><span class="p">,</span> 
                       <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                       <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Validation&#39;</span><span class="p">],</span> <span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_58_0.png" src="../_images/ValidationStrategies_58_0.png" />
</div>
</div>
<p>We can also compute the performances on the next <code class="docutils literal notranslate"><span class="pre">n_folds</span></code> weeks using the same code, but setting the starting day for training in such a way that estimates for the test period are obtained. This allows to provide confidence intervals for the performances on the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span>

<span class="n">performances_df_prequential_test</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">list_params</span><span class="p">:</span>
    
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">performances_df_prequential_test</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">prequential_validation</span><span class="p">(</span>
            <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
            <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training</span> 
                <span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">delta_test</span><span class="o">*</span><span class="p">(</span><span class="n">n_folds</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> 
            <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
            <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
            <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
            <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span>
            <span class="n">type_test</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">parameter_summary</span><span class="o">=</span><span class="n">max_depth</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    
<span class="n">performances_df_prequential_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total execution time: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total execution time: 53.54s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Test Std</th>
      <th>Average precision Test Std</th>
      <th>Card Precision@100 Test Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.791909</td>
      <td>0.541761</td>
      <td>0.265000</td>
      <td>0.807785</td>
      <td>0.592120</td>
      <td>0.394643</td>
      <td>0.017769</td>
      <td>0.031476</td>
      <td>0.019756</td>
      <td>0.011559</td>
      <td>0.017914</td>
      <td>0.004088</td>
      <td>3.404004</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.809012</td>
      <td>0.578885</td>
      <td>0.281429</td>
      <td>0.820076</td>
      <td>0.623315</td>
      <td>0.410714</td>
      <td>0.009125</td>
      <td>0.014434</td>
      <td>0.015940</td>
      <td>0.007795</td>
      <td>0.015303</td>
      <td>0.003712</td>
      <td>3.928414</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.812555</td>
      <td>0.601088</td>
      <td>0.282500</td>
      <td>0.829963</td>
      <td>0.645225</td>
      <td>0.412500</td>
      <td>0.010319</td>
      <td>0.020216</td>
      <td>0.015199</td>
      <td>0.006963</td>
      <td>0.015748</td>
      <td>0.005285</td>
      <td>3.725971</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.810138</td>
      <td>0.600306</td>
      <td>0.284286</td>
      <td>0.835835</td>
      <td>0.658589</td>
      <td>0.416071</td>
      <td>0.008586</td>
      <td>0.016797</td>
      <td>0.004286</td>
      <td>0.008285</td>
      <td>0.015249</td>
      <td>0.008353</td>
      <td>4.961377</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.804437</td>
      <td>0.585132</td>
      <td>0.281429</td>
      <td>0.847145</td>
      <td>0.671259</td>
      <td>0.420000</td>
      <td>0.007974</td>
      <td>0.005053</td>
      <td>0.007626</td>
      <td>0.007900</td>
      <td>0.016706</td>
      <td>0.006145</td>
      <td>4.066389</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.782710</td>
      <td>0.554860</td>
      <td>0.268929</td>
      <td>0.859658</td>
      <td>0.692724</td>
      <td>0.427500</td>
      <td>0.012483</td>
      <td>0.011771</td>
      <td>0.009813</td>
      <td>0.013379</td>
      <td>0.012199</td>
      <td>0.012990</td>
      <td>4.978631</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.774783</td>
      <td>0.544933</td>
      <td>0.263571</td>
      <td>0.865567</td>
      <td>0.708766</td>
      <td>0.429643</td>
      <td>0.014568</td>
      <td>0.003392</td>
      <td>0.007593</td>
      <td>0.015050</td>
      <td>0.009896</td>
      <td>0.012951</td>
      <td>4.452925</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.761763</td>
      <td>0.520208</td>
      <td>0.258571</td>
      <td>0.877844</td>
      <td>0.721114</td>
      <td>0.431786</td>
      <td>0.012098</td>
      <td>0.012309</td>
      <td>0.009949</td>
      <td>0.012280</td>
      <td>0.014920</td>
      <td>0.012792</td>
      <td>5.070283</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.758138</td>
      <td>0.504909</td>
      <td>0.257500</td>
      <td>0.881659</td>
      <td>0.737896</td>
      <td>0.435357</td>
      <td>0.011140</td>
      <td>0.013154</td>
      <td>0.010467</td>
      <td>0.012795</td>
      <td>0.012402</td>
      <td>0.012990</td>
      <td>5.592131</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.754024</td>
      <td>0.439422</td>
      <td>0.261071</td>
      <td>0.969552</td>
      <td>0.878847</td>
      <td>0.491429</td>
      <td>0.009848</td>
      <td>0.034828</td>
      <td>0.014335</td>
      <td>0.010886</td>
      <td>0.026480</td>
      <td>0.021500</td>
      <td>6.487757</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.797221</td>
      <td>0.334055</td>
      <td>0.258214</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.568571</td>
      <td>0.005425</td>
      <td>0.020390</td>
      <td>0.012095</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.014250</td>
      <td>6.767934</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us plot the validation and test accuracies in terms of AUC ROC, AP and CP&#64;100, as a function of the decision tree depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;Average precision Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test Std&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;AUC ROC Test Std&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Average precision Test Std&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;Average precision Test Std&#39;</span><span class="p">]</span>
<span class="n">performances_df_prequential</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test Std&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">performances_df_prequential_test</span><span class="p">[</span><span class="s1">&#39;Card Precision@100 Test Std&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_prequential</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>Average precision Validation</th>
      <th>Card Precision@100 Validation</th>
      <th>AUC ROC Train</th>
      <th>Average precision Train</th>
      <th>Card Precision@100 Train</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation Std</th>
      <th>AUC ROC Train Std</th>
      <th>Average precision Train Std</th>
      <th>Card Precision@100 Train Std</th>
      <th>Execution time</th>
      <th>Parameters summary</th>
      <th>AUC ROC Test</th>
      <th>Average precision Test</th>
      <th>Card Precision@100 Test</th>
      <th>AUC ROC Test Std</th>
      <th>Average precision Test Std</th>
      <th>Card Precision@100 Test Std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.790786</td>
      <td>0.549767</td>
      <td>0.256429</td>
      <td>0.804231</td>
      <td>0.593561</td>
      <td>0.402500</td>
      <td>0.012035</td>
      <td>0.022134</td>
      <td>0.014481</td>
      <td>0.013359</td>
      <td>0.018224</td>
      <td>0.040474</td>
      <td>3.666392</td>
      <td>2</td>
      <td>0.791909</td>
      <td>0.541761</td>
      <td>0.265000</td>
      <td>0.017769</td>
      <td>0.031476</td>
      <td>0.019756</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.802717</td>
      <td>0.573414</td>
      <td>0.267143</td>
      <td>0.818140</td>
      <td>0.623562</td>
      <td>0.421429</td>
      <td>0.017607</td>
      <td>0.027186</td>
      <td>0.016067</td>
      <td>0.011437</td>
      <td>0.016412</td>
      <td>0.032214</td>
      <td>3.414093</td>
      <td>3</td>
      <td>0.809012</td>
      <td>0.578885</td>
      <td>0.281429</td>
      <td>0.009125</td>
      <td>0.014434</td>
      <td>0.015940</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.800690</td>
      <td>0.554134</td>
      <td>0.264286</td>
      <td>0.825978</td>
      <td>0.644766</td>
      <td>0.426429</td>
      <td>0.017878</td>
      <td>0.038293</td>
      <td>0.014321</td>
      <td>0.009928</td>
      <td>0.018337</td>
      <td>0.034144</td>
      <td>3.765976</td>
      <td>4</td>
      <td>0.812555</td>
      <td>0.601088</td>
      <td>0.282500</td>
      <td>0.010319</td>
      <td>0.020216</td>
      <td>0.015199</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.804218</td>
      <td>0.546094</td>
      <td>0.267857</td>
      <td>0.831289</td>
      <td>0.657368</td>
      <td>0.431429</td>
      <td>0.016505</td>
      <td>0.042197</td>
      <td>0.013869</td>
      <td>0.007867</td>
      <td>0.016387</td>
      <td>0.029881</td>
      <td>3.788764</td>
      <td>5</td>
      <td>0.810138</td>
      <td>0.600306</td>
      <td>0.284286</td>
      <td>0.008586</td>
      <td>0.016797</td>
      <td>0.004286</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.798603</td>
      <td>0.537006</td>
      <td>0.264643</td>
      <td>0.839032</td>
      <td>0.669597</td>
      <td>0.432143</td>
      <td>0.024225</td>
      <td>0.037056</td>
      <td>0.008474</td>
      <td>0.002592</td>
      <td>0.012448</td>
      <td>0.028383</td>
      <td>4.170064</td>
      <td>6</td>
      <td>0.804437</td>
      <td>0.585132</td>
      <td>0.281429</td>
      <td>0.007974</td>
      <td>0.005053</td>
      <td>0.007626</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.795636</td>
      <td>0.530609</td>
      <td>0.262500</td>
      <td>0.846446</td>
      <td>0.681837</td>
      <td>0.436429</td>
      <td>0.023144</td>
      <td>0.040323</td>
      <td>0.006804</td>
      <td>0.005559</td>
      <td>0.008949</td>
      <td>0.026351</td>
      <td>4.368153</td>
      <td>7</td>
      <td>0.782710</td>
      <td>0.554860</td>
      <td>0.268929</td>
      <td>0.012483</td>
      <td>0.011771</td>
      <td>0.009813</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.795142</td>
      <td>0.516246</td>
      <td>0.260714</td>
      <td>0.859548</td>
      <td>0.694885</td>
      <td>0.440000</td>
      <td>0.023081</td>
      <td>0.033545</td>
      <td>0.009715</td>
      <td>0.008063</td>
      <td>0.009498</td>
      <td>0.031380</td>
      <td>4.966671</td>
      <td>8</td>
      <td>0.774783</td>
      <td>0.544933</td>
      <td>0.263571</td>
      <td>0.014568</td>
      <td>0.003392</td>
      <td>0.007593</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.785849</td>
      <td>0.505189</td>
      <td>0.260357</td>
      <td>0.864869</td>
      <td>0.717259</td>
      <td>0.447500</td>
      <td>0.026249</td>
      <td>0.040393</td>
      <td>0.009813</td>
      <td>0.011527</td>
      <td>0.015346</td>
      <td>0.028453</td>
      <td>4.757738</td>
      <td>9</td>
      <td>0.761763</td>
      <td>0.520208</td>
      <td>0.258571</td>
      <td>0.012098</td>
      <td>0.012309</td>
      <td>0.009949</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.786784</td>
      <td>0.493543</td>
      <td>0.257143</td>
      <td>0.887622</td>
      <td>0.727672</td>
      <td>0.448571</td>
      <td>0.031165</td>
      <td>0.048307</td>
      <td>0.009949</td>
      <td>0.011532</td>
      <td>0.018154</td>
      <td>0.028962</td>
      <td>5.247802</td>
      <td>10</td>
      <td>0.758138</td>
      <td>0.504909</td>
      <td>0.257500</td>
      <td>0.011140</td>
      <td>0.013154</td>
      <td>0.010467</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.780408</td>
      <td>0.450980</td>
      <td>0.264286</td>
      <td>0.964275</td>
      <td>0.862459</td>
      <td>0.496786</td>
      <td>0.022168</td>
      <td>0.031413</td>
      <td>0.007890</td>
      <td>0.007512</td>
      <td>0.014831</td>
      <td>0.031483</td>
      <td>6.802245</td>
      <td>20</td>
      <td>0.754024</td>
      <td>0.439422</td>
      <td>0.261071</td>
      <td>0.009848</td>
      <td>0.034828</td>
      <td>0.014335</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.822564</td>
      <td>0.341818</td>
      <td>0.265714</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.578571</td>
      <td>0.013407</td>
      <td>0.026227</td>
      <td>0.008512</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.028732</td>
      <td>7.768848</td>
      <td>50</td>
      <td>0.797221</td>
      <td>0.334055</td>
      <td>0.258214</td>
      <td>0.005425</td>
      <td>0.020390</td>
      <td>0.012095</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span><span class="n">performances_df_prequential</span><span class="p">,</span> 
                       <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                       <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Validation&#39;</span><span class="p">],</span> <span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_65_0.png" src="../_images/ValidationStrategies_65_0.png" />
</div>
</div>
<p>The resulting plot shows a better agreement between the validation and test performances for the three performance metrics. The AUC ROC remains problematic, since it would select a depth of 50 as the best performance for the validation set, whereas optimal depths are in the range 3 to 6. The AP and CP&#64;100 however follow similar trends for the validation and test set.</p>
<p>The prequential validation offers the most robust way to perform model selection and will be the preferred approach in the rest of this book. It should however be noted that it is computationally intensive since it requires the creation of several prediction models for each tested model parameter.</p>
</div>
<div class="section" id="integration-in-scikit-learn">
<span id="sklearn-validation-pipeline"></span><h2><span class="section-number">2.5. </span>Integration in Scikit-learn<a class="headerlink" href="#integration-in-scikit-learn" title="Permalink to this headline">¶</a></h2>
<p>Scikit-learn (also known as <em>sklearn</em>) is the reference library for machine learning in Python. Since validation and model selection are essential steps in the design of machine learning prediction models, sklearn provides <a class="reference external" href="https://scikit-learn.org/stable/model_selection.html">a wide range of techniques for assessing and validating prediction models</a>.</p>
<p>Sklearn however offers few possibilities for performing validation on sequential data. In particular, the prequential validation presented in the previous section, and the Card Precision metric are not provided.</p>
<p>This last section aims at bridging this gap, by adding both prequential validation and the CP metric to the validation and model selection pipelines provided by sklearn. The benefits will be to gain access to high-level functions from the sklearn library. These include, among others, the ability to</p>
<ul class="simple">
<li><p>easily parallelize code execution</p></li>
<li><p>rely on sklearn <em>pipelines</em> for data transformation</p></li>
<li><p>rely on different strategies for hyperparameter tuning (exhaustive search, random search, …).</p></li>
</ul>
<div class="section" id="prequential-splitting">
<h3><span class="section-number">2.5.1. </span>Prequential splitting<a class="headerlink" href="#prequential-splitting" title="Permalink to this headline">¶</a></h3>
<p>Scikit-learn provides seven different strategies for splitting data for validation: <code class="docutils literal notranslate"><span class="pre">KFold</span></code>, <code class="docutils literal notranslate"><span class="pre">GroupKFold</span></code>, <code class="docutils literal notranslate"><span class="pre">ShuffleSplit</span></code>, <code class="docutils literal notranslate"><span class="pre">StratifiedKFold</span></code>, <code class="docutils literal notranslate"><span class="pre">GroupShuffleSplit</span></code>, <code class="docutils literal notranslate"><span class="pre">StratifiedShuffleSplit</span></code>, and <code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code>. A visualization of these splitting strategies is provided <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/model_selection/plot_cv_indices.html">here</a>. None of these allows the prequential splitting of data illustrated in Fig. 5.</p>
<p>Let us define a <code class="docutils literal notranslate"><span class="pre">prequentialSplit</span></code> function, that returns the indices of the training and test sets for each of the folds of a prequential split.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prequentialSplit</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                     <span class="n">start_date_training</span><span class="p">,</span> 
                     <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                     <span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                     <span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                     <span class="n">delta_assessment</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    
    <span class="n">prequential_split_indices</span><span class="o">=</span><span class="p">[]</span>
        
    <span class="c1"># For each fold</span>
    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_folds</span><span class="p">):</span>
        
        <span class="c1"># Shift back start date for training by the fold index times the assessment period (delta_assessment)</span>
        <span class="c1"># (See Fig. 5)</span>
        <span class="n">start_date_training_fold</span> <span class="o">=</span> <span class="n">start_date_training</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">fold</span><span class="o">*</span><span class="n">delta_assessment</span><span class="p">)</span>
        
        <span class="c1"># Get the training and test (assessment) sets</span>
        <span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span><span class="o">=</span><span class="n">get_train_test_set</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                                               <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_fold</span><span class="p">,</span>
                                               <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span><span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span><span class="n">delta_test</span><span class="o">=</span><span class="n">delta_assessment</span><span class="p">)</span>
    
        <span class="c1"># Get the indices from the two sets, and add them to the list of prequential splits</span>
        <span class="n">indices_train</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">indices_test</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">prequential_split_indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">indices_train</span><span class="p">,</span><span class="n">indices_test</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">prequential_split_indices</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="card-precision-top-k">
<h3><span class="section-number">2.5.2. </span>Card Precision top-k<a class="headerlink" href="#card-precision-top-k" title="Permalink to this headline">¶</a></h3>
<p>Custom metrics can be implemented in sklearn thanks to the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.make_scorer.html"><code class="docutils literal notranslate"><span class="pre">make_scorer</span></code></a> factory function. The computation of the Card Precision top-k requires the scoring function to be aware of the customer ID and the day of the transation (see Section <a class="reference internal" href="../Chapter_4_PerformanceMetrics/TopKBased.html#precision-top-k-metrics"><span class="std std-ref">Precision Top K Metrics</span></a>). This is done by passing the <code class="docutils literal notranslate"><span class="pre">transactions_df</span></code> DataFrame as an argument to the function. More details on the design of custom scoring functions can be found <a class="reference external" href="https://scikit-learn.org/stable/modules/model_evaluation.html#scoring">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">card_precision_top_k_custom</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">transactions_df</span><span class="p">):</span>
    
    <span class="c1"># Let us create a predictions_df DataFrame, that contains all transactions matching the indices of the current fold</span>
    <span class="c1"># (indices of the y_true vector)</span>
    <span class="n">predictions_df</span><span class="o">=</span><span class="n">transactions_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y_true</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">predictions_df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">y_pred</span>
    
    <span class="c1"># Compute the CP@k using the function implemented in Chapter 4, Section 4.2</span>
    <span class="n">nb_compromised_cards_per_day</span><span class="p">,</span><span class="n">card_precision_top_k_per_day_list</span><span class="p">,</span><span class="n">mean_card_precision_top_k</span><span class="o">=</span>\
        <span class="n">card_precision_top_k</span><span class="p">(</span><span class="n">predictions_df</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
    
    <span class="c1"># Return the mean_card_precision_top_k</span>
    <span class="k">return</span> <span class="n">mean_card_precision_top_k</span>

<span class="c1"># Only keep columns that are needed as argument to the custom scoring function</span>
<span class="c1"># (in order to reduce the serialization time of transaction dataset)</span>
<span class="n">transactions_df_scorer</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">[[</span><span class="s1">&#39;CUSTOMER_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;TX_FRAUD&#39;</span><span class="p">,</span><span class="s1">&#39;TX_TIME_DAYS&#39;</span><span class="p">]]</span>

<span class="c1"># Make scorer using card_precision_top_k_custom</span>
<span class="n">card_precision_top_100</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">make_scorer</span><span class="p">(</span><span class="n">card_precision_top_k_custom</span><span class="p">,</span> 
                                                     <span class="n">needs_proba</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                     <span class="n">top_k</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                                                     <span class="n">transactions_df</span><span class="o">=</span><span class="n">transactions_df_scorer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="grid-search">
<h3><span class="section-number">2.5.3. </span>Grid search<a class="headerlink" href="#grid-search" title="Permalink to this headline">¶</a></h3>
<p>Sklearn allows to automate the fitting and assessment of models with different hyperparameters by means of the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html">GridSearchCV function</a>.</p>
<p>Its main parameters are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">estimator</span></code>: The estimator to use, which will be a decision tree in the following example.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">param_grid</span></code>: The set of hyperparameters for the estimator. We will vary the decision tree depth (<code class="docutils literal notranslate"><span class="pre">max_depth</span></code>) parameter, and set the random state (<code class="docutils literal notranslate"><span class="pre">random_state</span></code>) for reproduciblity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scoring</span></code>: The scoring functions to use. We will use the AUC ROC, Average Precision, and CP&#64;100.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_jobs</span></code>: The number of cores to use. We will set it to -1, that is, to using all the available cores.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refit</span></code>: Whether the model should be fitted with all data after the cross validation. This will be set to false, since we only require the results of the cross validation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cv</span></code>: The cross-validation splitting strategy. The prequential validation will be used, by passing the indices returned by the <code class="docutils literal notranslate"><span class="pre">prequentialSplit</span></code> function.</p></li>
</ul>
<p>Let us set these parameters, and instantiate a <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimator to use</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">()</span>

<span class="c1"># Hyperparameters to test</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clf__max_depth&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;clf__random_state&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">]}</span>

<span class="c1"># Scoring functions. AUC ROC and Average Precision are readily available from sklearn </span>
<span class="c1"># with `auc_roc` and `average_precision`. Card Precision@100 was implemented with the make_scorer factory function. </span>
<span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
           <span class="s1">&#39;average_precision&#39;</span><span class="p">:</span> <span class="s1">&#39;average_precision&#39;</span><span class="p">,</span>
           <span class="s1">&#39;card_precision@100&#39;</span><span class="p">:</span> <span class="n">card_precision_top_100</span>
           <span class="p">}</span>

<span class="c1"># A pipeline is created to scale data before fitting a model</span>
<span class="n">estimators</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">classifier</span><span class="p">)]</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">estimators</span><span class="p">)</span>

<span class="c1"># Indices for the prequential validation are obtained with the prequentialSplit function</span>
<span class="n">prequential_split_indices</span> <span class="o">=</span> <span class="n">prequentialSplit</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                                             <span class="n">start_date_training_with_valid</span><span class="p">,</span> 
                                             <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span>
                                             <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                             <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                             <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_valid</span><span class="p">)</span>

<span class="c1"># Let us instantiate the GridSearchCV</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> \
                                                   <span class="n">cv</span><span class="o">=</span><span class="n">prequential_split_indices</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># And select the input features, and output feature</span>
<span class="n">X</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">[</span><span class="n">input_features</span><span class="p">]</span>
<span class="n">y</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">[</span><span class="n">output_feature</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The fitting and assessment is performed by calling the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function of the <code class="docutils literal notranslate"><span class="pre">grid_search</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">time</span> grid_search.fit(X, y)

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished CV fitting&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 152 ms, sys: 259 ms, total: 411 ms
Wall time: 6.51 s
Finished CV fitting
</pre></div>
</div>
</div>
</div>
<p>The results of the cross validation can be retrieved with the <code class="docutils literal notranslate"><span class="pre">cv_results_</span></code> attribute. It contains the scoring for each fold and scoring metrics, together with statistics on the execution times.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;mean_fit_time&#39;: array([1.05854368, 1.27579147]),
 &#39;std_fit_time&#39;: array([0.0081484 , 0.01675179]),
 &#39;mean_score_time&#39;: array([0.29740781, 0.21103078]),
 &#39;std_score_time&#39;: array([0.00725061, 0.00444517]),
 &#39;param_clf__max_depth&#39;: masked_array(data=[2, 4],
              mask=[False, False],
        fill_value=&#39;?&#39;,
             dtype=object),
 &#39;param_clf__random_state&#39;: masked_array(data=[0, 0],
              mask=[False, False],
        fill_value=&#39;?&#39;,
             dtype=object),
 &#39;params&#39;: [{&#39;clf__max_depth&#39;: 2, &#39;clf__random_state&#39;: 0},
  {&#39;clf__max_depth&#39;: 4, &#39;clf__random_state&#39;: 0}],
 &#39;split0_test_roc_auc&#39;: array([0.7750121 , 0.78393251]),
 &#39;split1_test_roc_auc&#39;: array([0.80873906, 0.82871798]),
 &#39;split2_test_roc_auc&#39;: array([0.79140481, 0.78643512]),
 &#39;split3_test_roc_auc&#39;: array([0.78798838, 0.80367453]),
 &#39;mean_test_roc_auc&#39;: array([0.79078609, 0.80069003]),
 &#39;std_test_roc_auc&#39;: array([0.01203472, 0.01787799]),
 &#39;rank_test_roc_auc&#39;: array([2, 1], dtype=int32),
 &#39;split0_test_average_precision&#39;: array([0.5235482 , 0.53514015]),
 &#39;split1_test_average_precision&#39;: array([0.58466274, 0.60015739]),
 &#39;split2_test_average_precision&#39;: array([0.54253116, 0.50175204]),
 &#39;split3_test_average_precision&#39;: array([0.5483265 , 0.57948508]),
 &#39;mean_test_average_precision&#39;: array([0.54976715, 0.55413367]),
 &#39;std_test_average_precision&#39;: array([0.02213352, 0.03829317]),
 &#39;rank_test_average_precision&#39;: array([2, 1], dtype=int32),
 &#39;split0_test_card_precision@100&#39;: array([0.24285714, 0.24857143]),
 &#39;split1_test_card_precision@100&#39;: array([0.24285714, 0.25714286]),
 &#39;split2_test_card_precision@100&#39;: array([0.26285714, 0.26428571]),
 &#39;split3_test_card_precision@100&#39;: array([0.27714286, 0.28714286]),
 &#39;mean_test_card_precision@100&#39;: array([0.25642857, 0.26428571]),
 &#39;std_test_card_precision@100&#39;: array([0.01448081, 0.01432138]),
 &#39;rank_test_card_precision@100&#39;: array([2, 1], dtype=int32)}
</pre></div>
</div>
</div>
</div>
<p>Let us rearrange these results in a more readable format:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">expe_type</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span>

<span class="n">performance_metrics_list_grid</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;average_precision&#39;</span><span class="p">,</span> <span class="s1">&#39;card_precision@100&#39;</span><span class="p">]</span>
<span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">]</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">performance_metrics_list_grid</span><span class="p">)):</span>
    <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metrics_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">expe_type</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_&#39;</span><span class="o">+</span><span class="n">performance_metrics_list_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metrics_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">expe_type</span><span class="o">+</span><span class="s1">&#39; Std&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_&#39;</span><span class="o">+</span><span class="n">performance_metrics_list_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

<span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Execution time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_fit_time&#39;</span><span class="p">]</span>

<span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Validation</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation</th>
      <th>Card Precision@100 Validation Std</th>
      <th>Execution time</th>
      <th>Parameters</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.790786</td>
      <td>0.012035</td>
      <td>0.549767</td>
      <td>0.022134</td>
      <td>0.256429</td>
      <td>0.014481</td>
      <td>1.058544</td>
      <td>{'clf__max_depth': 2, 'clf__random_state': 0}</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.800690</td>
      <td>0.017878</td>
      <td>0.554134</td>
      <td>0.038293</td>
      <td>0.264286</td>
      <td>0.014321</td>
      <td>1.275791</td>
      <td>{'clf__max_depth': 4, 'clf__random_state': 0}</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="integration">
<h3><span class="section-number">2.5.4. </span>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h3>
<p>The same results as in the <a class="reference internal" href="#prequential-validation"><span class="std std-ref">previous section</span></a> can be obtained using <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code>. Let us first define a function <code class="docutils literal notranslate"><span class="pre">prequential_grid_search</span></code>, that implements the grid search as above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prequential_grid_search</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span> 
                            <span class="n">classifier</span><span class="p">,</span> 
                            <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span> 
                            <span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="p">,</span> 
                            <span class="n">start_date_training</span><span class="p">,</span> 
                            <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">expe_type</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
                            <span class="n">delta_train</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                            <span class="n">delta_delay</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                            <span class="n">delta_assessment</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                            <span class="n">performance_metrics_list_grid</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">],</span>
                            <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">],</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    
    <span class="n">estimators</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">classifier</span><span class="p">)]</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">estimators</span><span class="p">)</span>
    
    <span class="n">prequential_split_indices</span><span class="o">=</span><span class="n">prequentialSplit</span><span class="p">(</span><span class="n">transactions_df</span><span class="p">,</span>
                                               <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training</span><span class="p">,</span> 
                                               <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span> 
                                               <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
                                               <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
                                               <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_assessment</span><span class="p">)</span>
    
    <span class="n">grid_search</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">prequential_split_indices</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
    
    <span class="n">X</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">[</span><span class="n">input_features</span><span class="p">]</span>
    <span class="n">y</span><span class="o">=</span><span class="n">transactions_df</span><span class="p">[</span><span class="n">output_feature</span><span class="p">]</span>

    <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">performance_metrics_list_grid</span><span class="p">)):</span>
        <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metrics_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">expe_type</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_&#39;</span><span class="o">+</span><span class="n">performance_metrics_list_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">performances_df</span><span class="p">[</span><span class="n">performance_metrics_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">expe_type</span><span class="o">+</span><span class="s1">&#39; Std&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_&#39;</span><span class="o">+</span><span class="n">performance_metrics_list_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
    <span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Execution time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">grid_search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_fit_time&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">performances_df</span>

        
</pre></div>
</div>
</div>
</div>
<p>We can estimate the validation performances of a decision tree model for varying depth by setting <code class="docutils literal notranslate"><span class="pre">start_date_training</span></code> to <code class="docutils literal notranslate"><span class="pre">start_date_training_with_valid</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">()</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clf__max_depth&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;clf__random_state&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">]}</span>

<span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
           <span class="s1">&#39;average_precision&#39;</span><span class="p">:</span> <span class="s1">&#39;average_precision&#39;</span><span class="p">,</span>
           <span class="s1">&#39;card_precision@100&#39;</span><span class="p">:</span> <span class="n">card_precision_top_100</span><span class="p">,</span>
           <span class="p">}</span>

<span class="n">performances_df_validation</span><span class="o">=</span><span class="n">prequential_grid_search</span><span class="p">(</span>
    <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
    <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="p">,</span> 
    <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training_with_valid</span><span class="p">,</span>
    <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span>
    <span class="n">expe_type</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span>
    <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
    <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
    <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_valid</span><span class="p">,</span>
    <span class="n">performance_metrics_list_grid</span><span class="o">=</span><span class="n">performance_metrics_list_grid</span><span class="p">,</span>
    <span class="n">performance_metrics_list</span><span class="o">=</span><span class="n">performance_metrics_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation: Total execution time: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Validation: Total execution time: 21.65s
</pre></div>
</div>
</div>
</div>
<p>And the test performances by setting <code class="docutils literal notranslate"><span class="pre">start_date_training</span></code> accordingly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">performances_df_test</span><span class="o">=</span><span class="n">prequential_grid_search</span><span class="p">(</span>
    <span class="n">transactions_df</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> 
    <span class="n">input_features</span><span class="p">,</span> <span class="n">output_feature</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="p">,</span> 
    <span class="n">start_date_training</span><span class="o">=</span><span class="n">start_date_training</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">n_folds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delta_test</span><span class="p">),</span>
    <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span>
    <span class="n">expe_type</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
    <span class="n">delta_train</span><span class="o">=</span><span class="n">delta_train</span><span class="p">,</span> 
    <span class="n">delta_delay</span><span class="o">=</span><span class="n">delta_delay</span><span class="p">,</span> 
    <span class="n">delta_assessment</span><span class="o">=</span><span class="n">delta_test</span><span class="p">,</span>
    <span class="n">performance_metrics_list_grid</span><span class="o">=</span><span class="n">performance_metrics_list_grid</span><span class="p">,</span>
    <span class="n">performance_metrics_list</span><span class="o">=</span><span class="n">performance_metrics_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test: Total execution time: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test: Total execution time: 21.02s
</pre></div>
</div>
</div>
</div>
<p>Let us concatenate the validation and test performances in a single DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df_validation</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">,</span><span class="s1">&#39;Execution time&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">performances_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">performances_df_test</span><span class="p">,</span><span class="n">performances_df_validation</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the max_depth as the label for plotting</span>
<span class="n">parameters_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">])</span>
<span class="n">max_depth</span><span class="o">=</span><span class="p">[</span><span class="n">parameters_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;clf__max_depth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters_dict</span><span class="p">))]</span>
<span class="n">performances_df</span><span class="p">[</span><span class="s1">&#39;Parameters summary&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">max_depth</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">performances_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AUC ROC Test</th>
      <th>AUC ROC Test Std</th>
      <th>Average precision Test</th>
      <th>Average precision Test Std</th>
      <th>Card Precision@100 Test</th>
      <th>Card Precision@100 Test Std</th>
      <th>Parameters</th>
      <th>Execution time</th>
      <th>AUC ROC Validation</th>
      <th>AUC ROC Validation Std</th>
      <th>Average precision Validation</th>
      <th>Average precision Validation Std</th>
      <th>Card Precision@100 Validation</th>
      <th>Card Precision@100 Validation Std</th>
      <th>Parameters summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.791909</td>
      <td>0.017769</td>
      <td>0.541761</td>
      <td>0.031476</td>
      <td>0.265000</td>
      <td>0.019756</td>
      <td>{'clf__max_depth': 2, 'clf__random_state': 0}</td>
      <td>0.961201</td>
      <td>0.790786</td>
      <td>0.012035</td>
      <td>0.549767</td>
      <td>0.022134</td>
      <td>0.256429</td>
      <td>0.014481</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.809012</td>
      <td>0.009125</td>
      <td>0.578885</td>
      <td>0.014434</td>
      <td>0.281429</td>
      <td>0.015940</td>
      <td>{'clf__max_depth': 3, 'clf__random_state': 0}</td>
      <td>0.974105</td>
      <td>0.802717</td>
      <td>0.017607</td>
      <td>0.573414</td>
      <td>0.027186</td>
      <td>0.267143</td>
      <td>0.016067</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.812555</td>
      <td>0.010319</td>
      <td>0.601088</td>
      <td>0.020216</td>
      <td>0.282500</td>
      <td>0.015199</td>
      <td>{'clf__max_depth': 4, 'clf__random_state': 0}</td>
      <td>1.052066</td>
      <td>0.800690</td>
      <td>0.017878</td>
      <td>0.554134</td>
      <td>0.038293</td>
      <td>0.264286</td>
      <td>0.014321</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.810138</td>
      <td>0.008586</td>
      <td>0.600306</td>
      <td>0.016797</td>
      <td>0.284286</td>
      <td>0.004286</td>
      <td>{'clf__max_depth': 5, 'clf__random_state': 0}</td>
      <td>1.283144</td>
      <td>0.804218</td>
      <td>0.016505</td>
      <td>0.546094</td>
      <td>0.042197</td>
      <td>0.267857</td>
      <td>0.013869</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.804437</td>
      <td>0.007974</td>
      <td>0.585132</td>
      <td>0.005053</td>
      <td>0.281429</td>
      <td>0.007626</td>
      <td>{'clf__max_depth': 6, 'clf__random_state': 0}</td>
      <td>1.634223</td>
      <td>0.798603</td>
      <td>0.024225</td>
      <td>0.537006</td>
      <td>0.037056</td>
      <td>0.264643</td>
      <td>0.008474</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.782710</td>
      <td>0.012483</td>
      <td>0.554860</td>
      <td>0.011771</td>
      <td>0.268929</td>
      <td>0.009813</td>
      <td>{'clf__max_depth': 7, 'clf__random_state': 0}</td>
      <td>1.494083</td>
      <td>0.795636</td>
      <td>0.023144</td>
      <td>0.530609</td>
      <td>0.040323</td>
      <td>0.262500</td>
      <td>0.006804</td>
      <td>7</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.774783</td>
      <td>0.014568</td>
      <td>0.544933</td>
      <td>0.003392</td>
      <td>0.263571</td>
      <td>0.007593</td>
      <td>{'clf__max_depth': 8, 'clf__random_state': 0}</td>
      <td>1.539149</td>
      <td>0.795142</td>
      <td>0.023081</td>
      <td>0.516246</td>
      <td>0.033545</td>
      <td>0.260714</td>
      <td>0.009715</td>
      <td>8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.761763</td>
      <td>0.012098</td>
      <td>0.520208</td>
      <td>0.012309</td>
      <td>0.258571</td>
      <td>0.009949</td>
      <td>{'clf__max_depth': 9, 'clf__random_state': 0}</td>
      <td>1.371046</td>
      <td>0.785849</td>
      <td>0.026249</td>
      <td>0.505189</td>
      <td>0.040393</td>
      <td>0.260357</td>
      <td>0.009813</td>
      <td>9</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.758138</td>
      <td>0.011140</td>
      <td>0.504909</td>
      <td>0.013154</td>
      <td>0.257500</td>
      <td>0.010467</td>
      <td>{'clf__max_depth': 10, 'clf__random_state': 0}</td>
      <td>1.442724</td>
      <td>0.786784</td>
      <td>0.031165</td>
      <td>0.493543</td>
      <td>0.048307</td>
      <td>0.257143</td>
      <td>0.009949</td>
      <td>10</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.754024</td>
      <td>0.009848</td>
      <td>0.439422</td>
      <td>0.034828</td>
      <td>0.261071</td>
      <td>0.014335</td>
      <td>{'clf__max_depth': 20, 'clf__random_state': 0}</td>
      <td>2.176944</td>
      <td>0.780408</td>
      <td>0.022168</td>
      <td>0.450980</td>
      <td>0.031413</td>
      <td>0.264286</td>
      <td>0.007890</td>
      <td>20</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.797221</td>
      <td>0.005425</td>
      <td>0.334055</td>
      <td>0.020390</td>
      <td>0.258214</td>
      <td>0.012095</td>
      <td>{'clf__max_depth': 50, 'clf__random_state': 0}</td>
      <td>2.687324</td>
      <td>0.822564</td>
      <td>0.013407</td>
      <td>0.341818</td>
      <td>0.026227</td>
      <td>0.265714</td>
      <td>0.008512</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us plot the performances for better visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_performances_plots</span><span class="p">(</span><span class="n">performances_df</span><span class="p">,</span> 
                       <span class="n">performance_metrics_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">,</span> <span class="s1">&#39;Average precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Card Precision@100&#39;</span><span class="p">],</span> 
                       <span class="n">expe_type_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span><span class="s1">&#39;Validation&#39;</span><span class="p">],</span><span class="n">expe_type_color_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#008000&#39;</span><span class="p">,</span><span class="s1">&#39;#FF0000&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ValidationStrategies_92_0.png" src="../_images/ValidationStrategies_92_0.png" />
</div>
</div>
<p>The results are the same as those obtained in Section <a class="reference internal" href="#prequential-validation"><span class="std std-ref">Prequential Validation</span></a>.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_5_ModelValidationAndSelection"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="Introduction.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">1. </span>Introduction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="ModelSelection.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Model selection</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By <a href="https://mlg.ulb.ac.be/wordpress/">Machine Learning Group (Université Libre de Bruxelles - ULB)</a>.<br/>
        
          <div class="extra_footer">
            <p>
Code released under a <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU GPL v3.0 license</a>. 
Prose and pictures released under a <a href="https://creativecommons.org/licenses/by-sa/4.0/"> CC BY-SA 4.0 license</a>.
</p>

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>